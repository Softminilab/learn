# 网络中，为什么需要存储转发传输？


❗️ 答案由 Gemini 提供。



----



好的，这是一个非常核心的网络基础问题。我们可以用一个简单的比喻来开始：

想象一下邮局的分拣中心。当一个包裹到达时，分拣员不会只看一眼收件地址就立刻把它扔到下一辆邮车上。他会做以下几件事：
1.  **完整接收 (Store)**：先把整个包裹从邮车上拿下来，放在分拣台上。
2.  **检查 (Check)**：检查包裹是否完整，有没有破损，面单信息是否清晰。
3.  **决策 (Process)**：根据完整的收件地址，决定这个包裹应该被送到哪个城市的下一站。
4.  **发送 (Forward)**：将包裹放入去往正确城市的邮袋或邮车中。

这个过程就是“存储转发”（Store-and-Forward）。网络设备（如交换机和路由器）使用这种机制的原因，也和邮局的逻辑类似，主要有以下几个关键点：

### 为什么需要“存储转发”？

#### 1. **错误检测 (Error Checking) - 这是最主要的原因**

*   **是什么**：网络中传输的数据帧（Frame）在末尾通常会包含一个叫做**帧检验序列 (FCS - Frame Check Sequence)** 的字段。发送方在发送数据前会通过一个算法（如CRC循环冗余校验）计算出整个数据帧的校验值并放入FCS字段。
*   **为什么重要**：接收设备（如交换机）**必须接收完整个数据帧**，才能用同样的算法计算一遍校验值，并与FCS字段中的值进行比对。
    *   如果两者**一致**，说明数据帧在传输过程中没有损坏，可以安全地转发出去。
    *   如果两者**不一致**，说明数据帧已经损坏（变成了“坏帧”或“错误帧”），交换机就会直接**丢弃**这个帧。
*   **带来的好处**：这种机制可以**防止错误的数据在网络中不断传播**。如果一个坏帧被转发，它会白白占用后续链路的带宽，并消耗下一台设备的处理资源，最终到达目的地时还是会被丢弃，造成了极大的浪费。存储转发从源头上就净化了网络流量。

#### 2. **支持不同速率的端口 (Rate Matching)**

*   一个交换机上可能连接着不同速率的设备，比如一个端口是10Gbps，另一个端口是1Gbps。
*   当一个10Gbps的端口向一个1Gbps的端口发送数据时，速度明显不匹配。如果没有“存储”这个环节，数据会因为来不及发送而大量丢失。
*   **存储转发**机制允许交换机将来自高速端口的数据帧先完整地存入**缓冲区 (Buffer)**，然后再以较慢的速度从低速端口发送出去。这就像一个水坝，可以调节上下游的水流速度，起到了缓冲和流量控制的作用。

#### 3. **支持不同的网络介质 (Media Translation)**

*   网络设备可能需要连接不同类型的物理介质，比如一端是双绞线（Ethernet），另一端是光纤。
*   存储转发允许设备在接收完一种介质的帧后，有时间将其转换成另一种介质所需的格式和电/光信号再发送出去。

#### 4. **访问控制和策略执行 (Access Control & Policy Enforcement)**

*   在更高级的交换机或路由器上，设备可能需要检查数据帧/包的更多信息（例如源/目的IP地址、端口号等）来执行安全策略，比如防火墙规则或服务质量（QoS）标记。
*   这些检查通常需要访问数据包的多个部分，因此必须先将整个数据包存储下来才能进行完整的分析和决策。

---

### 与“存储转发”相对的概念：直通式转发 (Cut-Through)

为了更好地理解存储转发的必要性，我们可以看看它的替代方案：

*   **直通式转发 (Cut-Through)**：交换机一旦接收到数据帧的目的MAC地址（帧的头部很靠前的位置），就立刻开始向目标端口转发数据，而不需要等待整个帧接收完毕。
*   **优点**：**延迟极低**。因为它几乎是“边收边发”，所以处理速度非常快。
*   **缺点**：它**无法进行错误检测**。如果一个帧是坏的，它同样会被转发出去，污染整个网络。它只能过滤掉一些最明显的“残帧”（长度过小的帧）。

### 总结与对比

| 特性         | 存储转发 (Store-and-Forward)       | 直通式转发 (Cut-Through)                     |
| :----------- | :--------------------------------- | :------------------------------------------- |
| **工作方式** | 接收完整数据帧 -> 检查 -> 转发     | 接收帧头 -> 立即转发                         |
| **错误处理** | **非常可靠**，会丢弃错误帧         | **不可靠**，会转发错误帧                     |
| **延迟**     | 相对较高（微秒级）                 | 极低（纳秒级）                               |
| **适用场景** | 大多数通用网络环境，**可靠性优先** | 对延迟极度敏感的场景，如高性能计算、高频交易 |
| **设备要求** | 需要更大的缓冲区                   | 缓冲区要求较低                               |

**结论：**

**存储转发是网络可靠性的基石。** 它通过牺牲一点点延迟（在现代硬件中这点延迟通常可以忽略不计），换来了**数据传输的完整性和网络的健康**。它确保了只有正确无误的数据才能在网络中流动，避免了“垃圾数据”造成的带宽浪费和网络拥堵。

对于**路由器 (Router)** 来说，它**必须**使用存储转发模式，因为它工作在网络层，需要检查整个IP包的头部信息（如TTL、IP校验和）来做出路由决策，这是直通式转发无法做到的。

而现代的很多交换机非常智能，可以采用**混合模式**：默认使用直通式以追求低延迟，但如果检测到某个端口的错误率过高，就会自动切换到存储转发模式，以保证网络的稳定。